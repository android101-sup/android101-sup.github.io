<html lang="en">

<head>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    <title>Android 101  | Step 5: Database Integration</title>

    <!-- CSS and JS -->
    <link  rel="stylesheet" href="/css/bootstrap.css" /><link  rel="stylesheet" href="/css/theme.css" /><link  rel="stylesheet" href="/css/stylesheet.css" />
    <script defer="defer"  src="/js/jquery.js"></script><script defer="defer"  src="/js/bootstrap.js"></script><script defer="defer"  src="/js/scripts.js"></script>

    <!-- Custom Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700|Playfair+Display" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="/">Android 101</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->

            <!-- Autogenerate pages -->
            <!-- <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                
                    <li class="">
                        <a href="/concepts.html">Concepts</a>
                    </li>
                
                    <li class="">
                        <a href="/resources.html">Resources</a>
                    </li>
                
                    <li class="">
                        <a href="/setup.html">Setup</a>
                    </li>
                
                    <li class="">
                        <a href="/code/01-hello-world.html">Step 1: Hello World</a>
                    </li>
                
                    <li class="">
                        <a href="/code/02-widgets-and-resources.html">Step 2: Widgets and Resources</a>
                    </li>
                
                    <li class="">
                        <a href="/code/03-activity-to-fragment.html">Step 3: Activity to Fragment</a>
                    </li>
                
                    <li class="">
                        <a href="/code/04-5-sdk-23-permissions.html">Step 4.5: SDK 23+ Permissions</a>
                    </li>
                
                    <li class="">
                        <a href="/code/04-implementation.html">Step 4: Implementation</a>
                    </li>
                
                    <li class="selected">
                        <a href="/code/05-database-integration.html">Step 5: Database Integration</a>
                    </li>
                
                    <li class="">
                        <a href="/sup/step1.html">Step 1: Hello World</a>
                    </li>
                
                    <li class="">
                        <a href="/sup/step2.html">Step 2: Widgets and Resources</a>
                    </li>
                
                    <li class="">
                        <a href="/sup/step3.html">Step 3: Activity to Fragment</a>
                    </li>
                
                    <li class="">
                        <a href="/sup/step4-5.html">Step 4.5: SDK 23+ Permissions</a>
                    </li>
                
                    <li class="">
                        <a href="/sup/step4.html">Step 4: Implementation</a>
                    </li>
                
                    <li class="">
                        <a href="/sup/step5.html">Step 5: Database Integration</a>
                    </li>
                
                </ul>
            </div> -->

            <!-- The old boring way -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
                <li class="">
                  <a href="/setup.html">Setup</a>
                </li>
                <li class="dropdown selected">
                  <a id="dLabel" data-target="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                    Sup
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" aria-labelledby="dLabel">
                    <li>
                      <a href="/sup/step1.html">Step 1: Hello World</a>
                    </li>
                    <li>
                      <a href="/sup/step2.html">Step 2: Widgets and Resources</a>
                    </li>
                    <li>
                      <a href="/sup/step3.html">Step 3: Activity to Fragment</a>
                    </li>
                    <li>
                      <a href="/sup/step4.html">Step 4: Implementation</a>
                    </li>
                    <li>
                      <a href="/sup/step4-5.html">Step 4.5: SDK 23+ Permissions</a>
                    </li>
                    <li>
                      <a href="/sup/step5.html">Step 5: Database Integration</a>
                    </li>
                  </ul>
                </li>
                <li class="">
                  <a href="/concepts.html">Concepts</a>
                </li>
                <li class="">
                  <a href="/resources.html">Resources</a>
                </li>
              </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>


    <div class="container">
    <h2>Step 5: Database Integration</h2>

    <div class="sct sct-primary">
        <h3>Configure the TextView</h3>

        <p>First, we have to configure our <b><span class="code">TextView</span></b> to properly display our last sup sent in the format we previously established in our <span class="code">strings.xml</span>.</p>
        
        <p><b>Update our <span class="code">emptyLatestSup</span> string</b> in <span class="code">res/values/strings.xml</span> and replace the todo with with <span class="code">"No sups sent recently."</span></p>

        <p>Next, we will <b>add an <span class="code">OnClickListener</span> to <span class="code">mLastSupSent</span>.</b> Add the following fields to the top of our <span class="code">SupFragment.java</span></p>
        
<pre class="code-block">
<span class="black"><b><span class="blue">private</span></b> String <b><span class="purple">mLastSupSentFormat</span></b>;
<b><span class="blue">private</span></b> String <b><span class="purple">mSupDateFormat</span></b>;
</span></pre>

        <p>Next, <b>add the following to our <span class="code">onCreateView()</span></b> below our reference to <span class="code">mLastSupSent</span>.</p>
        
<pre class="code-block">
<span class="black"><b><span class="purple">mSupDateFormat</span></b> = getString(R.string.<b><i><span class="purple">dateFormat</span></i></b>);
<b><span class="purple">mLastSupSentFormat</span></b> = getString(R.string.<b><i><span class="purple">latestSupFormat</span></i></b>);
String lastSupText = SupDao.get(getContext()).getLatestSup(mLastSupSentFormat, mSupDateFormat);
<b><span class="blue">if</span></b> (lastSupText == <b><span class="blue">null</span></b>) {
    lastSupText = getString(R.string.<b><i><span class="purple">emptyLatestSup</span></i></b>);
}
<b><span class="purple">mLastSupSent</span></b>.setText(lastSupText);
</span></pre>

        <p>In our <b><span class="code">sendSup()</span></b> method, <b>add the following two calls in our <span class="code">finally</span> block.</b></p>

<pre class="code-block">
<span class="black">saveSup();
setLatestSup();</span>
</pre>

        <p>Now let's define these methods. <b>Add these to <span class="code">SupFragment.java</span></b>.</p>

<pre class="code-block">
<span class="black"><b><span class="blue">private</span></b> <b><span class="blue">void</span></b> saveSup() {
    Sup sup = <b><span class="blue">new</span></b> Sup(<span class="purple">mFriend</span>, <b><span class="blue">new</span></b> Date());
    SupDao.get(getContext()).addSup(sup);
}

<b><span class="blue">private</span></b> <b><span class="blue">void</span></b> setLatestSup() {
    String lastSupText = SupDao.get(getContext()).getLatestSup(<span class="purple">mLastSupSentFormat</span>, <span class="purple">mSupDateFormat</span>);
    <b><span class="blue">if</span></b> (lastSupText == <b><span class="blue">null</span></b>) {
        lastSupText = getString(R.string.<b><i><span class="purple">emptyLatestSup</span></i></b>);
    }
    <b><span class="purple">mLastSupSent</span></b>.setText(lastSupText);
}</span>
</pre>
    </div>

    <div class="sct sct-secondary">
        <h3>Sup</h3>

        <p>Next we need to create a model object which will be saved into our database. <b>Create a new class called <span class="code">Sup</span></b> in <span class="code">com.uci.android101.sup</span> and use the following: </p>

<pre class="code-block">
<span class="black"><b><span class="blue">public</span></b> <b><span class="blue">class</span></b> Sup {

    <b><span class="blue">private</span></b> UUID <b><span class="grey">mId</span></b>;
    <b><span class="blue">private</span></b> Friend <b><span class="grey">mFriend</span></b>;
    <b><span class="blue">private</span></b> Date <b><span class="grey">mDate</span></b>;

    <b><span class="blue">public</span></b> Sup(Friend friend, Date date) {
        <b><span class="blue">this</span></b>.mId = UUID.randomUUID();
        <b><span class="blue">this</span></b>.mFriend = friend;
        <b><span class="blue">this</span></b>.mDate = date;
    }

    <b><span class="blue">public</span></b> UUID getId() {
        <b><span class="blue">return</span></b> <span class="purple">mId</span>;
    }

    <b><span class="blue">public</span></b> Friend getFriend() {
        <b><span class="blue">return</span></b> <span class="purple">mFriend</span>;
    }

    <b><span class="blue">public</span></b> <b><span class="blue">void</span></b> setFriend(Friend friend) {
        <b><span class="blue">this</span></b>.mFriend = friend;
    }

    <b><span class="blue">public</span></b> Date getDate() {
        <b><span class="blue">return</span></b> <span class="purple">mDate</span>;
    }

    <b><span class="blue">public</span></b> <b><span class="blue">void</span></b> setDate(Date date) {
        <b><span class="blue">this</span></b>.mDate = date;
    }

}</span>
</pre>
    </div>

    <div class="sct sct-primary">
        <h3>Sup Schema</h3>
        <p>Now we have to define a schema for our database. <b>Create a new subfolder</b>, com.uci.android101.sup.database, and <b>create a class in this folder called <span class="code">SupDbSchema</span></b>. The contents of our schema class should be as follows:</p>
<pre class="code-block">
<span class="black"><b><span class="blue">public</span></b> <b><span class="blue">class</span></b> SupDbSchema {

    <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> <b><span class="blue">class</span></b> SupTable {

        <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> String <span class="grey">NAME</span> = <span class="green">"sups"</span>;

        <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> <b><span class="blue">class</span></b> Cols {
            <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> String <span class="grey">UUID</span> = <span class="green">"uuid"</span>;
            <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> String <span class="grey">NAME</span> = <span class="green">"name"</span>;
            <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> String <span class="grey">DATE</span> = <span class="green">"date"</span>;
        }
    }
    
}</span>
</pre>
    </div>

    <div class="sct sct-secondary">
        <h3>SQLiteOpenHelper</h3>

        <p>Android provides the <b><span class="code">SQLiteOpenHelper</span></b> class to handle database creation and maintenance. <b>Create a class in our database package that subclasses <span class="code">SQLiteOpenHelper</span> called <span class="code">SupBaseHelper</span></b>.</p>
        
<pre class="code-block">
<span class="black"><b><span class="blue">public</span></b> <b><span class="blue">class</span></b> SupBaseHelper <b><span class="blue">extends</span></b> SQLiteOpenHelper {

    <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> <b><span class="blue">int</span></b> <b><span class="grey">VERSION</span></b> = 1;
    <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> <b><span class="blue">final</span></b> String <b><span class="grey">DATABASE_NAME</span></b> = "supBase.db";
    
    <b><span class="blue">public</span></b> SupBaseHelper(Context context) {
        <b><span class="blue">super</span></b>(context, <b><span class="purple">DATABASE_NAME</span></b>, <b><span class="blue">null</span></b>, <b><span class="purple">VERSION</span></b>);
    }

    <b><span class="yellow">@Override</span></b>
    <b><span class="blue">public</span></b> <b><span class="blue">void</span></b> onCreate(SQLiteDatabase sqLiteDatabase) {
        sqLiteDatabase.execSQL(<span class="green">"create table "</span> + SupDbSchema.SupTable.<b><span class="purple">NAME</span></b> + <span class="green">"("</span> +
            <span class="green">" _id integer primary key autoincrement, "</span> +
            SupDbSchema.SupTable.Cols.<b><span class="purple">UUID</span></b> + <span class="green">", "</span> +
            SupDbSchema.SupTable.Cols.<b><span class="purple">NAME</span></b> + <span class="green">", "</span> +
            SupDbSchema.SupTable.Cols.<b><span class="purple">DATE</span></b> + <span class="green">")"</span>);
    }

    <b><span class="yellow">@Override</span></b>
    <b><span class="blue">public</span></b> <b><span class="blue">void</span></b> onUpgrade(SQLiteDatabase sqLiteDatabase, <b><span class="purple">int</span></b> i, <b><span class="purple">int</span></b> i1) {
        <b><span class="blue">return</span></b>;
    }
}</span>
</pre>
    </div>

    <div class="sct sct-primary">
        <h3>SupDao</h3>

        <p>Lastly we need to <b>create <span class="code">SupDao</span></b>, our data access object, in com.uci.android101.sup.</p>
    
<pre class="code-block">
<span class="black"><b><span class="blue">public</span></b> <b><span class="blue">class</span></b> SupDao {

    <b><span class="blue">private</span></b> <b><span class="blue">static</span></b> SupDao <b><span class="grey">sSupDao</span></b>;
    <b><span class="blue">private</span></b> SQLiteDatabase <b><span class="grey">mDatabase</span></b>;

    <b><span class="blue">public</span></b> <b><span class="blue">static</span></b> SupDao get(Context context) {
        <b><span class="blue">if</span></b> (sSupDao == <b><span class="blue">null</span></b>) {
            <b><span class="purple">sSupDao</span></b> = <b><span class="blue">new</span></b> SupDao(context);
        }
        <b><span class="blue">return</span></b> sSupDao;
    }

    <b><span class="blue">private</span></b> SupDao(Context context) {
        <b><span class="purple">mDatabase</span></b> = <b><span class="blue">new</span></b> SupBaseHelper(context.getApplicationContext()).getWritableDatabase();
    }

    <b><span class="blue">public</span></b> <b><span class="blue">void</span></b> addSup(Sup sup) {
        ContentValues values = getContentValues(sup);
        <b><span class="purple">mDatabase</span></b>.insert(SupDbSchema.SupTable.<b><span class="purple">NAME</span></b>, <b><span class="blue">null</span></b>, values);
    }

    <b><span class="blue">public</span></b> String getLatestSup(String latestSupFormat, String dateFormat) {
        SupCursorWrapper cursor = querySups();
        <b><span class="blue">try</span></b> {
            <b><span class="blue">if</span></b> (cursor.getCount() == 0) {
                <b><span class="blue">return</span></b> <b><span class="blue">null</span></b>;
            }
            cursor.moveToFirst();
            <b><span class="blue">return</span></b> cursor.getLatestSup(latestSupFormat, dateFormat);
        } <b><span class="blue">finally</span></b> {
            cursor.close();
        }
    }

    <b><span class="blue">private</span></b> SupCursorWrapper querySups() {
        Cursor cursor = mDatabase.query(
                SupDbSchema.SupTable.<b><span class="purple">NAME</span></b>,
                <b><span class="blue">null</span></b>,
                <b><span class="blue">null</span></b>,
                <b><span class="blue">null</span></b>,
                <b><span class="blue">null</span></b>,
                <b><span class="blue">null</span></b>,
                SupDbSchema.SupTable.Cols.<b><span class="purple">DATE</span></b> + <span class="green">" DESC"</span>,
                <span class="green">"1"</span>
        );
        <b><span class="blue">return</span></b> <b><span class="blue">new</span></b> SupCursorWrapper(cursor);
    }

    <b><span class="blue">private</span></b> <b><span class="blue">static</span></b> ContentValues getContentValues(Sup sup) {
        ContentValues values = <b><span class="blue">new</span></b> ContentValues();
        values.put(SupDbSchema.SupTable.Cols.<b><span class="purple">UUID</span></b>, sup.getId().toString());
        values.put(SupDbSchema.SupTable.Cols.<b><span class="purple">NAME</span></b>, sup.getFriend().getFriendName());
        values.put(SupDbSchema.SupTable.Cols.<b><span class="purple">DATE</span></b>, sup.getDate().getTime());
        <b><span class="blue">return</span></b> values;
    }

    <b><span class="blue">private</span></b> class SupCursorWrapper <b><span class="blue">extends</span></b> CursorWrapper {
        <b><span class="blue">public</span></b> SupCursorWrapper(Cursor cursor) {
            <b><span class="blue">super</span></b>(cursor);
        }

        <b><span class="blue">public</span></b> String getLatestSup(String latestSupFormat, String dateFormat) {
            DateTime dateTime = <b><span class="blue">new</span></b> DateTime(getLong(getColumnIndex(SupDbSchema.SupTable.Cols.<b><span class=purple>DATE</span></b>)));
            DateTimeFormatter fmt = DateTimeFormat.forPattern(dateFormat);
            String dateString = fmt.print(dateTime);
            String friendName = getString(getColumnIndex(SupDbSchema.SupTable.Cols.<b><span class="purple">NAME</span></b>));
            <b><span class="blue">return</span></b> String.format(latestSupFormat, friendName, dateString);
        }
    }

}</span>
</pre>

        <p>You may notice that you have errors for our new datetime classes. This is because we need to <b>add another library dependency</b>, like some may have done in <a href="/sup/step2.html">Step 2</a>. Add the following dependency and then resolve all of your imports.</p>

        <img src="/assets/05_AddLibraryDependency.png" class="semi-full">

        <p><b>Now, run your app and send some sups!</b> Your last sup sent field should properly display the information of when and to whom the last sup was sent.</p>
    </div>

    <div class="sct">
        <div class="falling-behind">
            <h3>Falling Behind?</h3>
            <p>Either through the Git Shell (Windows) or in your Terminal (all other OS's), in your project directory, enter:</p>
            <pre>git checkout mainline</pre>
            <p>Or, if you are using a device that's SDK 23 or higher, enter:</p>
            <pre>git checkout mainline-sdk23</pre>
        </div>
    </div>
</div>

    <!-- Bottom padding -->
    
        <div class="container"></div>
    

</body>

</html>